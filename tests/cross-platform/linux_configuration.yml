project:
  name: "buildfab-platform-test"
  modules: ["buildfab"]
  bin: "bin"

stages:
  check-detection:
    steps:
      - action: platform-validation-test

actions:
  - name: platform-validation-test
    run: |
      echo "=== Buildfab Platform Detection Validation Test ==="
      echo "Testing on: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2 2>/dev/null || echo "Unknown Linux")"
      echo ""
      
      # Expected values for Linux
      expected_platform="linux"
      expected_arch="amd64"
      expected_cpu_min=1
      
      # Get actual values from buildfab variables
      actual_platform="${{ platform }}"
      actual_arch="${{ arch }}"
      actual_os="${{ os }}"
      actual_os_version="${{ os_version }}"
      actual_cpu="${{ cpu }}"
      
      echo "=== Validation Results ==="
      
      # Validate platform
      if [ "$actual_platform" = "$expected_platform" ]; then
          echo "✅ Platform: $actual_platform (CORRECT)"
      else
          echo "❌ Platform: $actual_platform (EXPECTED: $expected_platform)"
          exit 1
      fi
      
      # Validate architecture
      if [ "$actual_arch" = "$expected_arch" ]; then
          echo "✅ Architecture: $actual_arch (CORRECT)"
      else
          echo "❌ Architecture: $actual_arch (EXPECTED: $expected_arch)"
          exit 1
      fi
      
      # Validate OS (should be ubuntu or debian)
      if [ "$actual_os" = "ubuntu" ] || [ "$actual_os" = "debian" ]; then
          echo "✅ OS: $actual_os (CORRECT - valid Linux distribution)"
      else
          echo "❌ OS: $actual_os (EXPECTED: ubuntu or debian)"
          exit 1
      fi
      
      # Validate OS Version (should be numeric)
      if echo "$actual_os_version" | grep -qE '^[0-9]+(\.[0-9]+)*$'; then
          echo "✅ OS Version: $actual_os_version (CORRECT - valid version format)"
      else
          echo "❌ OS Version: $actual_os_version (EXPECTED: numeric version like 24.04 or 12)"
          exit 1
      fi
      
      # Validate CPU count (should be positive integer)
      if [ "$actual_cpu" -ge "$expected_cpu_min" ]; then
          echo "✅ CPU: $actual_cpu cores (CORRECT - >= $expected_cpu_min)"
      else
          echo "❌ CPU: $actual_cpu cores (EXPECTED: >= $expected_cpu_min)"
          exit 1
      fi
      
      echo ""
      echo "=== All Platform Detection Validations Passed! ==="
      echo "✅ Platform detection test completed successfully"

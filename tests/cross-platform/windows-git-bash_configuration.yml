project:
  name: "buildfab-platform-test"
  modules: ["buildfab"]
  bin: "bin"

stages:
  check-detection:
    steps:
      - action: wine-test
      - action: cmd-validation-test
      - action: shell-configuration-test

actions:
  - name: wine-test
    uses: version@check
    
  - name: cmd-validation-test
    shell: cmd
    run: |
      echo "=== Windows cmd.exe Validation Test ==="
      echo "Testing Windows cmd.exe under Wine emulation"
      echo ""
      
      # Expected values for Windows under Wine
      expected_platform=windows
      expected_arch=amd64
      expected_os=windows
      expected_cpu_min=1
      
      # Get actual values from buildfab variables
      actual_platform=%{{ platform }}%
      actual_arch=%{{ arch }}%
      actual_os=%{{ os }}%
      actual_os_version=%{{ os_version }}%
      actual_cpu=%{{ cpu }}%
      
      echo "=== cmd.exe Validation Results ==="
      
      # Validate platform
      if "%actual_platform%"=="%expected_platform%" (
          echo "✅ Platform: %actual_platform% (CORRECT)"
      ) else (
          echo "❌ Platform: %actual_platform% (EXPECTED: %expected_platform%)"
          exit /b 1
      )
      
      # Validate architecture
      if "%actual_arch%"=="%expected_arch%" (
          echo "✅ Architecture: %actual_arch% (CORRECT)"
      ) else (
          echo "❌ Architecture: %actual_arch% (EXPECTED: %expected_arch%)"
          exit /b 1
      )
      
      # Validate OS
      if "%actual_os%"=="%expected_os%" (
          echo "✅ OS: %actual_os% (CORRECT)"
      ) else (
          echo "❌ OS: %actual_os% (EXPECTED: %expected_os%)"
          exit /b 1
      )
      
      # Validate CPU count (basic check)
      echo "✅ CPU: %actual_cpu% cores (CORRECT - cmd.exe validation)"
      
      echo ""
      echo "=== cmd.exe Validation Passed! ==="
      
  - name: shell-configuration-test
    shell: cmd
    run: |
      echo "=== Shell Configuration Feature Test ==="
      echo "Testing buildfab shell configuration with cmd.exe"
      echo ""
      echo "This test demonstrates that:"
      echo "1. buildfab can execute shell commands with specified shells"
      echo "2. Platform detection variables work correctly"
      echo "3. Shell configuration feature works with cmd.exe (Windows native)"
      echo ""
      echo "Shell successfully validated platform detection:"
      echo "Platform: %{{ platform }}%"
      echo "Architecture: %{{ arch }}%"
      echo "OS: %{{ os }}%"
      echo "OS Version: %{{ os_version }}%"
      echo "CPU: %{{ cpu }}%"
      echo ""
      echo "✅ Shell configuration test completed successfully"
